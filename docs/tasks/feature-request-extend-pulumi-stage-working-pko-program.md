# Feature Request: Extend Pulumi Promise Stage to Emit a Working PKO Program

## Outcome
Extend `stages/pulumi-promise` so each Kratix request is translated into a more complete Pulumi Kubernetes Operator (PKO) `Program` resource that follows the PKO API shape and includes the request details needed for successful reconciliation.

## Problem Statement
The current stage produces a `Program` object with request data nested under `spec.resources`.

Today in `stages/pulumi-promise/main.go`, the stage writes:
- `apiVersion: pulumi.com/v1`
- `kind: Program`
- `metadata.*` from the request
- `spec.resources.<component>.type`
- `spec.resources.<component>.properties` from request `spec`

However, PKO `Program` uses the `program` field (not `spec`) as the source-of-truth object for `resources`, `configuration`, `variables`, `outputs`, and `packages`. This mismatch means the generated object is incomplete and may not reconcile as expected.

## Research Summary
From PKO API and docs:
1. `ProgramSpec` defines `program` and related fields such as `configuration`, `resources`, `variables`, and `outputs`.
2. `Resource` entries support `type`, `properties`, and `options` (for dependencies, parent/provider wiring, protect/ignoreChanges, etc.).

## Why This Matters
Without the correct `program` structure, the stage output cannot be relied on as a valid PKO program contract. As component schemas and request payloads grow, users need deterministic mapping from request details into PKO-compatible program fields.

## Proposed Scope (Small Slices)
### Slice 1: Correct PKO Program shape
When making this change, treat this like a bug fix
1. Write component resource to `program.resources` instead of `spec.resources`.
2. Keep resource `type` and `properties` mapping unchanged (`properties` still sourced from request `spec`).
3. Preserve deterministic naming/namespace and metadata propagation.

### Slice 2: Auto-generate only schema-trusted values
When making this change, treat this like a feature for additional generated values
1. Load `schema.json` in the stage using `PULUMI_SCHEMA_SOURCE`.
2. Auto-generate only values that are fully deterministic and explicitly defined in schema:
   - `program.configuration` entries derived from package config definitions/defaults in schema.
3. Keep generation deterministic (sorted keys, stable output) and fail clearly when the schema source is unavailable or invalid at runtime.

### Slice 3: Deterministic required mapping from existing inputs
When making this change, treat this like a feature for additional configuration contract clarity
1. Clarify input boundaries for required PKO Program fields:
   - Existing user input remains request `spec` for component properties only.
   - No new required user-provided environment variables are introduced in this slice.
2. Map required PKO Program fields deterministically from existing inputs and stage context:
   - `program.resources.<component>.properties` from request `spec`,
   - `program.resources.<component>.type` from component selection,
   - deterministic metadata and naming from existing stage contract.
3. Keep request `spec` mapped only to `program.resources.<component>.properties` (no reserved Pulumi intent block in `spec`).
4. Keep optional environment variable passthrough explicitly out of scope for this slice; implement it in Slice 5 as follow-up work.

### Slice 4: README guidance for user-supplied Pulumi intent
1. Update the README generated by `kratix init pulumi-component-promise` to include a Pulumi-specific section that explains:
   - which fields are auto-generated from schema because they are trusted values,
   - that this Program feature introduces no new required environment variables for PKO required fields,
   - where to supply optional runtime intent (for example via a custom stage that updates the generated file before output),
   - an alternative option to write a custom stage that updates the generated file before it is written to outputs.
2. Ensure this guidance appears in both flat and split init outputs and is written in British English.

### Slice 5: Optional environment variable passthrough (follow-up slice)
When making this change, treat this like a feature for additional configuration
1. Support optional user inputs via environment variables for values that cannot be inferred with full confidence from schema:
   - `program.variables`
   - `program.outputs`
   - `program.resources.<component>.options` (for example `dependsOn`, `provider`, `protect`, `ignoreChanges`)
2. Validate and parse the environment variable payloads early, and fail with explicit, actionable errors when invalid.
3. Keep this slice additive: optional fields remain optional and must not change the required-field contract from Slice 3.

#### Contract proposal for optional environment variables
Environment variables should be clearly named and easy to update. Where possible use independent and simple variable types and allow the stage to manage merging into the Pulumi Program object. Where that is not possible, accept JSON directly.

Proposed optional environment variables:
```bash
# JSON object mapped to options.additionalSecretOutputs
PULUMI_PROGRAM_RESOURCE_OPTION_ADDITIONAL_SECRET_OUTPUTS='{"additionalSecretOutputs":["password"]}'

# JSON object mapped to options.aliases
PULUMI_PROGRAM_RESOURCE_OPTION_ALIASES='{"aliases":["urn:pulumi:dev::project::pkg:index:Thing::old-name"]}'

# JSON object mapped to options.customTimeouts
PULUMI_PROGRAM_RESOURCE_OPTION_CUSTOM_TIMEOUTS_CREATE='10m'
PULUMI_PROGRAM_RESOURCE_OPTION_CUSTOM_TIMEOUTS_UPDATE='10m'
PULUMI_PROGRAM_RESOURCE_OPTION_CUSTOM_TIMEOUTS_DELETE='10m'

# JSON boolean mapped to options.deleteBeforeReplace
PULUMI_PROGRAM_RESOURCE_OPTION_DELETE_BEFORE_REPLACE='true'

# JSON object mapped to options.dependsOn
PULUMI_PROGRAM_RESOURCE_OPTION_DEPENDS_ON='{"dependsOn":["pkg-index-network"]}'

# JSON string mapped to options.id
PULUMI_PROGRAM_RESOURCE_OPTION_ID='/subscriptions/123/resourceGroups/rg/providers/Microsoft.Storage/storageAccounts/example'

# JSON object mapped to options.ignoreChanges
PULUMI_PROGRAM_RESOURCE_OPTION_IGNORE_CHANGES='{"ignoreChanges":["tags[\"lastApplied\"]"]}'

# JSON string mapped to options.parent
PULUMI_PROGRAM_RESOURCE_OPTION_PARENT='pkg-index-platform'

# JSON string mapped to options.provider
PULUMI_PROGRAM_RESOURCE_OPTION_PROVIDER='pulumi:providers:aws::default_6_52_0'

# JSON object mapped to options.providers
PULUMI_PROGRAM_RESOURCE_OPTION_PROVIDERS='{"providers":["pulumi:providers:aws::default_6_52_0"]}'

# JSON boolean mapped to options.protect
PULUMI_PROGRAM_RESOURCE_OPTION_PROTECT='true'

# JSON object mapped to program.variables
PULUMI_PROGRAM_VARIABLES='{
  "provider": {
    "fn::invoke": {
      "function": "aws:index:getCallerIdentity"
    }
  }
}'

# JSON object mapped to program.outputs
PULUMI_PROGRAM_OUTPUTS='{
  "endpoint": {
    "fn::toJSON": "${pkg-index-database.endpoint}"
  }
}'
```

## Non-Goals
- No changes to Pulumi schema translation logic in `internal/pulumi` for CRD generation.
- No attempt to auto-generate fields that encode runtime intent, environment wiring, or policy choices.
- No change to how request `spec` includes only component properties that map to `program.resources.<component>.properties`.

## Backward Compatibility
- this is not needed

## Test Plan
Automated tests in `stages/pulumi-promise/test` should cover:
1. Emits `program.resources` (not `spec.resources`).
2. Auto-generated schema-trusted values are emitted deterministically.
3. No new required environment variables are needed for PKO Program required fields.
4. If slice 5 is implemented, optional environment variable configuration passthrough is complete.
5. If slice 5 is implemented, validation errors for malformed optional environment variable payloads are explicit.

CLI init tests should also cover:
1. Generated README tests are not based on exact text and are passing

Run via:
```bash
make test-pulumi-promise-stage
```
and ensure top-level integration remains green:
```bash
go test ./test/... -ginkgo.focus="init pulumi-component-promise"
```

## Acceptance Criteria
1. Stage output conforms to PKO `Program` field layout (`program.*`).
2. Only required fields that cannot be inferred or auto-generated are provided as stage environment variable input.
3. All request fields in the defined extension contract are represented in output deterministically.
4. Existing Pulumi init + stage tests are updated and pass.
5. Failure paths are explicit and junior-friendly.
6. Generated README documents both options for user intent handling: environment variables or a custom stage that updates generated files before outputs, in British English.

## Sources
- Pulumi Kubernetes Operator API docs (Program types): https://pkg.go.dev/github.com/pulumi/pulumi-kubernetes-operator/v2/operator/api/pulumi/v1
- PKO Program docs: https://raw.githubusercontent.com/pulumi/pulumi-kubernetes-operator/master/docs/programs.md
